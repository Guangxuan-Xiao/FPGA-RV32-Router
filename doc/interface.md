## 软硬件接口设计

首先该模块需要实现从路由器到CPU，以及从CPU到路由器的RIP包的双向传递。其中路由器到该模块的输入输出由AXIS协议的一系列信号来控制，CPU则是由地址映射等方式控制输入输出。为了能够实现这一点，我们需要在其中实现BRAM用于RIP包的缓存，从而使得两方可以进行数据包的交流。

### 第一种设计：双独立BRAM

首先，我们阐述一下关于BRAM参数方面的设计。在端口选取方面，我们使用True Dual Port，双口可读可写的端口设计，其中PortA为Router方面的端口，PortB为CPU方面的端口。由于Router方面，一次接收到的数据长度为8bits，所以我们将PortA的宽度设置为8bits。由于CPU方面，一条lw或sw指令进行访存的长度为32bits，所以我们将PortB的宽度设置为32bits。BRAM的存储结构是一维的，我们将它抽象为二维的。我们认为一个以太网帧的最大长度为2048bits，因为听说理论上一个以太网帧的最大长度为1514bits，而为了方便寻址等原因，我们将其向上取整为2048bits（二进制下）。而我们单个BRAM内预计缓存128个以太网帧，因此我们PortA深度为2048\*128/8=32768，而PortB深度为2048\*128/32=8192。经过计算这样消耗32KB，完全够用（指不超过1.6MB）。

值得一提的是，我们启用了8bits的写入字节使能，在CPU写入时，像BaseRAM等等一样，可以设置写入字节使能。

我们将使用两块如上所述的BRAM，一块作为路由器写，CPU读的用处，一块作为CPU写，路由器读的用途。


### 第二种设计：单BRAM+标志位

这种设计中，我们只需要一块BRAM，但是在向BRAM写入以太网帧的时候，首先需要在数据帧之前写入1-2个字节的标志位，该标志位用于路由器、CPU取出来判别当前数据帧的状态，例如路由器正在写入、CPU可以接受、CPU可以发送等不同状态，然后决定之后的操作。这种设计不需要引入新的BRAM，并且可以依靠状态位直接进行判断下一步的操作。

具体而言，假设路由器开始写入BRAM，那么首先写 00000001 代表路由器正在写入，如果CPU获取到了这条数据，那么会发现路由器正在写入，那么不进行取出。当AXIS的last出现后，则路由器写入完毕，那么数据帧之前的数据变成 00000010 代表由路由器写入，并且CPU可以取出。CPU开始取数据的时候标志位变为 00000100， CPU取完数据后标志位置为 00000000 代表数据为空。

反过来，CPU发包，那么正在写入时标志位为 00010000，写完后变为 00100000 并等待路由器的读取， 路由器正在读取则为 01000000，读取完后全部归零以示数据为空。

## 与院士的讨论

与院士讨论后，我们决定采用第一种设计。同时我们需要处理冲突的问题。暂定的方案是使用软件来进行仲裁，用CPU控制读写。院士还指出了我们的一个小错误，那就是以太网帧的最大长度为1514bytes，这样两个BRAM便使用了恰好0.5MB的空间，目前还是不超过1.6MB的限制的。